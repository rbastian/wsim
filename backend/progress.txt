
## 2026-01-19 - RNG Abstraction Implementation (wsim-0d0)

Implemented foundational Random Number Generator (RNG) abstraction to enable deterministic gameplay for testing and replay:

### Components Created:
- **RNG Abstract Base Class**: Defines interface with roll_d6(), roll_2d6(), and roll_dice(n, sides) methods
- **SeededRNG**: Deterministic RNG using a fixed seed for:
  - Test scenarios with reproducible outcomes
  - Replay functionality
  - Debugging game logic
- **UnseededRNG**: Standard RNG using system randomness for normal gameplay
- **create_rng() Factory**: Convenience function that returns SeededRNG when seed provided, UnseededRNG otherwise

### Test Coverage:
- Created 24 comprehensive tests organized into test classes:
  - TestSeededRNG: 7 tests for deterministic behavior
  - TestUnseededRNG: 5 tests for valid range checks
  - TestCreateRNG: 3 tests for factory function
  - TestRNGInterface: 6 parameterized tests verifying interface compliance
  - TestDeterministicGameplay: 3 integration tests demonstrating deterministic scenarios (combat, collision, full turn replay)
- All tests passing (139 total in test suite)

### Key Features:
- Custom number of sides supported (d4, d6, d10, d20, etc.)
- Same seed produces identical roll sequences across runs
- Easy dependency injection for engine components
- Type-safe with full ty type checking support

### Quality Checks:
- ✅ Ruff formatting and linting (all checks passed)
- ✅ Ty type checking (all checks passed)
- ✅ All pytest tests passing (139/139)

This RNG system will be used by collision detection, fouling rolls, combat hit resolution, and damage application systems.

## 2026-01-19 - Core Pydantic Models Implementation (wsim-vbx)

Implemented the foundational Pydantic v2 models for the WSIM game engine:

### Models Created:
- **Common Enums**: Side, Facing (8 directions), WindDirection, LoadState, GamePhase, Broadside, AimPoint
- **HexCoord**: Hex coordinate model with hash support for use as dict keys
- **Ship**: Complete ship state including:
  - Identity (id, name, side)
  - Position (bow_hex, stern_hex, facing)
  - Movement stats (battle_sail_speed)
  - Combat stats (guns_L/R, carronades_L/R)
  - Tracks (hull, rigging, crew, marines)
  - Load state (load_L/R)
  - Status flags (fouled, struck)
  - Drift tracking (turns_without_bow_advance)
- **Orders**: ShipOrders and TurnOrders for movement planning phase
- **Events**: DiceRoll and EventLogEntry for comprehensive audit trail
- **Game**: Complete game state with ships dict, wind, phase, event log, and helper methods

### Test Coverage:
- Created 39 comprehensive tests covering all models
- Tests include validation, edge cases, and model interactions
- All tests passing

### Quality Checks:
- ✅ Ruff formatting and linting (all checks passed)
- ✅ Ty type checking (all checks passed)
- ✅ All pytest tests passing (39/39)

### Configuration:
- Added per-file linting exception for Ship model (_L/_R suffix is domain convention)
- Configured ty overrides for test files to handle dynamic dict unpacking

This provides the solid foundation for all other game engine components.

## 2026-01-19 - Scenario Loader Implementation (wsim-wgw)

Implemented comprehensive scenario loading system to initialize games from JSON scenario files:

### Components Created:
- **Scenario Models** (scenario.py):
  - MapConfig, WindConfig, VictoryConfig
  - ShipStartPosition, ShipGuns, ShipCarronades, ShipInitialLoad
  - ScenarioShip: Complete ship definition for scenarios
  - Scenario: Top-level model with validation methods for ship ID uniqueness and map bounds

- **Scenario Loader** (scenario_loader.py):
  - load_scenario_from_file(): Load and validate from JSON files
  - load_scenario_from_dict(): Load and validate from dictionaries
  - initialize_game_from_scenario(): Convert Scenario to Game state
  - _calculate_stern_hex(): Calculate stern position based on bow and facing for all 8 directions
  - ScenarioLoadError: Custom exception for loading failures

### MVP Scenarios Created:
1. **Frigate Duel** (mvp_frigate_duel_v1.json): 1v1 frigate fight for learning basics
2. **Crossing Paths** (mvp_crossing_paths_v1.json): 2v2 sloops testing collision/fouling
3. **Two-Ship Line Battle** (mvp_two_ship_line_battle_v1.json): 2v2 mixed ships testing closest-target rule

### Test Coverage:
- Created 14 comprehensive tests covering:
  - Valid scenario loading from dict and file
  - Optional field handling
  - Validation error cases (missing fields, invalid enums)
  - Duplicate ship ID detection
  - Out of bounds ship detection
  - File I/O error handling (nonexistent files, invalid JSON)
  - Game initialization from scenarios
  - Stern hex calculation for all 8 facing directions
  - Loading all 3 real MVP scenario files
- All tests passing (14/14)

### Quality Checks:
- ✅ Ruff formatting and linting (all checks passed)
- ✅ Ty type checking (all checks passed)
- ✅ All pytest tests passing (14/14)

The scenario system is now complete and ready for use by the API layer to create games.

## 2026-01-19 - Movement Parser Implementation (wsim-7c6)

Implemented comprehensive movement notation parser that converts high-level movement strings into atomic actions:

### Components Created:
- **MovementActionType Enum**: Defines atomic action types (TURN_LEFT, TURN_RIGHT, MOVE_FORWARD, NO_MOVEMENT)
- **MovementAction Model**: Represents a single atomic movement action with optional distance for forward moves
- **ParsedMovement Model**: Result of parsing containing original notation, action sequence, and total forward hexes
- **parse_movement()**: Main parser function that:
  - Accepts notation like 'L1R1', '0', 'LLR2', 'R', '3'
  - Normalizes input (strips whitespace, converts to uppercase)
  - Validates syntax character by character
  - Expands digits into forward movement actions
  - Calculates total forward movement distance
  - Provides detailed error messages with character positions
- **validate_movement_within_allowance()**: Validates parsed movement doesn't exceed ship's movement allowance
- **MovementParseError**: Custom exception for parsing failures

### Movement Notation Rules:
- '0': No movement (can only appear alone)
- 'L': Turn left (60 degrees)
- 'R': Turn right (60 degrees)
- '1'-'9': Move forward that many hexes
- Combinations: 'L1R1' = turn left, move 1, turn right, move 1
- Case-insensitive with whitespace trimming

### Test Coverage:
- Created 29 comprehensive tests covering:
  - All basic notation types (turns, forward movement, no movement)
  - Complex sequences and combinations
  - Input normalization (lowercase, whitespace)
  - Movement allowance validation
  - Error cases (empty strings, invalid characters, '0' in sequences)
  - Pydantic model validation (negative distances, negative totals)
- All tests passing (29/29)

### Quality Checks:
- ✅ Ruff formatting and linting (all checks passed)
- ✅ Ty type checking (all checks passed)
- ✅ All pytest tests passing (84/84 total suite)

The movement parser is now complete and provides the foundation for the movement execution engine.

## 2026-01-19 - Simultaneous Movement Execution Engine (wsim-okz)

Implemented comprehensive movement execution engine that processes parsed movement actions step-by-step for all ships simultaneously:

### Components Created:
- **Hex Geometry Functions**:
  - turn_left(): Rotate facing 45 degrees counter-clockwise through all 8 compass directions
  - turn_right(): Rotate facing 45 degrees clockwise through all 8 compass directions
  - get_adjacent_hex(): Calculate adjacent hex in any direction using odd-q vertical layout
  - calculate_stern_from_bow(): Determine stern hex position from bow and facing

- **Ship Movement Functions**:
  - execute_ship_turn(): Execute turn action (left/right) updating facing and stern position
  - execute_ship_forward_movement(): Move ship forward N hexes with bounds checking
  - execute_simultaneous_movement(): Main execution function processing all ships in parallel

- **Movement State Models**:
  - ShipMovementState: Tracks per-ship execution progress (action index, hexes moved, bow advancement)
  - MovementExecutionResult: Result containing bow advancement flags and action count

- **MovementExecutionError**: Custom exception for execution failures

### Key Features:
- **Odd-q Vertical Hex Layout**: Proper hex geometry with offset coordinate system
  - Handles even/odd column differences in neighbor calculations
  - Supports all 8 compass directions (N, NE, E, SE, S, SW, W, NW)

- **Step-by-Step Simultaneous Execution**:
  - All ships execute their next action in parallel before advancing to next step
  - Maintains fairness and simultaneity required by game rules

- **Battle Sail Speed Enforcement**:
  - Validates total forward hexes don't exceed ship's movement allowance
  - Raises clear error if exceeded

- **Bounds Checking**:
  - Validates movements stay within map boundaries
  - Checks bounds at each step before creating invalid HexCoord

- **Bow Advancement Tracking**:
  - Tracks whether each ship's bow hex changed position
  - Critical for drift rule implementation

- **Position Consistency**:
  - Automatically recalculates stern position after turns
  - Ensures bow and stern always maintain proper relationship

### Test Coverage:
- Created 31 comprehensive tests covering:
  - Turn functions (left/right, full rotations, all 8 facings)
  - Adjacent hex calculation (even/odd columns, all 8 directions)
  - Stern calculation from bow (all 8 facings, both column parities)
  - Ship turn execution (single turns, sequences, validation)
  - Ship forward movement (single/multiple hexes, zero distance, bounds checking)
  - Simultaneous movement (single ship, multiple ships, complex sequences)
  - Movement allowance enforcement
  - Bow advancement tracking
  - Ship attribute preservation
- All tests passing (31/31)

### Quality Checks:
- ✅ Ruff formatting and linting (all checks passed)
- ✅ Ty type checking (all checks passed)
- ✅ All pytest tests passing (115/115 total suite)

The movement execution engine is now complete and provides the foundation for collision detection, fouling, and drift systems.

---

## Implementation: Fouling System (wsim-8gn)
**Date:** 2026-01-19
**Issue:** wsim-8gn
**Status:** Completed

Implemented a comprehensive fouling system that integrates with the collision detection system. When ships collide, the system now automatically rolls for fouling and applies fouled status to ships based on the outcome.

**Key Features:**
- Fouling check uses 1d6 roll: 1-3 results in fouling, 4-6 avoids fouling
- Automatic fouling checks after every collision resolution
- Fouled status tracked in ship model (field already existed)
- Full event logging for all fouling checks with roll results and outcomes
- Seamless integration with existing collision detection system

**Implementation:**
- Created `wsim_core/engine/fouling.py` module (~130 lines)
  - `check_fouling()`: Rolls for fouling and creates event log entries
  - `apply_fouling()`: Applies fouled status to ships
  - `check_and_apply_fouling()`: Convenience function combining both
- Updated `wsim_core/engine/collision.py`:
  - Modified `detect_and_resolve_collisions()` to call fouling checks after each collision
  - Added fouling event import and integration
- Updated `wsim_core/engine/__init__.py` to export fouling functions
- Updated existing collision tests to expect additional fouling events

**Testing:**
- Created comprehensive test suite: `tests/engine/test_fouling.py` with 15 tests
- Test coverage includes:
  - Fouling checks with various roll outcomes
  - Single ship (no fouling), two ships, multiple ships
  - Apply fouling to already-fouled ships
  - Partial ship ID handling
  - Event logging validation
  - Deterministic behavior with seeded RNG
  - State preservation (other ship properties unchanged)
- Updated 2 existing collision tests to account for fouling events
- All 167 tests pass

**Quality Checks:**
- ruff formatting: clean (2 files reformatted)
- ruff linting: clean (1 import order fix applied)
- ty type checking (strict mode): clean
- Full integration with existing systems working correctly

**Design Decisions:**
- Simplified MVP fouling rules (50/50 chance with 1d6)
- Fouling always checked after collisions (no option to skip)
- Both ships involved in collision get fouled status if roll succeeds
- Fouling state persists on ships for future movement restrictions
- Event logging provides full transparency for debugging/replay

**Integration Points:**
- Collision detection system (automatic integration)
- RNG system (uses injected RNG for determinism)
- Event logging system (creates fouling_check events)
- Ship model (uses existing fouled field)

**Next Steps:**
Ready to implement next priority task from Beads backlog. Fouling system is complete and tested.
