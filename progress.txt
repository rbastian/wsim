# WSIM Development Progress

## 2026-01-19

### Closest-Target Rule Enforcement (wsim-g4g) - COMPLETED
Implemented comprehensive target selection logic enforcing the closest-target rule for combat:

**Core Features:**
- `get_ships_in_arc()`: Finds all ships (any part - bow or stern) within a broadside's firing arc
- `get_closest_enemy_in_arc()`: Returns the closest enemy ship in arc per closest-target rule
- `get_all_valid_targets()`: Returns all valid targets (handles equidistant cases)
- `is_valid_target()`: Validates if a specific ship can be legally targeted
- `get_targeting_info()`: Provides detailed targeting information for debugging/UI
- `TargetInfo` class: Encapsulates target ship, distance, and hex position

**Rule Implementation:**
- Only enemy ships (different side) are valid targets
- Struck ships cannot be targeted
- Only the CLOSEST enemy in arc can be targeted (strict WS&IM rule)
- Friendly ships in arc are ignored (no friendly fire)
- Handles equidistant enemies (all at minimum distance are valid)
- Ships outside firing arc cannot be targeted
- Distance calculated using proper hex geometry

**Testing:**
- Comprehensive test suite with 26 tests covering:
  - Ships in arc detection (bow, stern, friendly, range limits)
  - Closest enemy selection (single, multiple, filtering struck ships)
  - Valid target list generation (equidistant handling)
  - Target validation (all rules enforced)
  - Targeting info generation for UI/debugging
  - Complex scenarios (screening, multi-ship targeting)
- All 237 project tests passing
- Edge cases: equidistant targets, struck ships, friendly screening, out-of-arc

**Quality:**
- Code formatted with ruff
- All linting checks pass
- Type checking passes with ty (strict mode)
- Proper integration with existing arc calculation system
- Ready for combat system implementation

**Next Steps:**
Ready to implement data-driven hit tables and resolution (wsim-ool).

## 2026-01-19

### Broadside Arc Determination (wsim-9bf) - COMPLETED
Implemented broadside arc calculation system for combat targeting:

**Core Features:**
- `get_broadside_arc_hexes()`: Calculates all hexes within a ship's broadside firing arc
- `hex_distance()`: Computes distance between two hexes using cube coordinate conversion
- `is_hex_in_broadside_arc()`: Quick check if a specific hex is in arc (with range validation)
- Broadsides fire perpendicular to ship facing (L=port/west, R=starboard/east)
- Arc extends in a cone pattern up to configurable max_range (default 10 hexes)

**Implementation Details:**
- Perpendicular direction mapping for all 8 facings (N, NE, E, SE, S, SW, W, NW)
- Each broadside uses 3 primary directions to create ~90 degree firing arc
- Cone tracing algorithm widens arc at distance for realistic coverage
- Proper handling of hex geometry with odd-q vertical layout
- Bounds checking prevents negative coordinates during arc generation

**Testing:**
- Comprehensive test suite with 21 tests covering:
  - Hex distance calculations (same hex, adjacent, diagonal, symmetry)
  - Arc generation (excludes ship position, respects range, left vs right different)
  - Directional correctness (N facing fires L=west, R=east; E facing fires L=north, R=south)
  - All 8 facings produce valid arcs for both broadsides
  - In-arc and out-of-arc detection
  - Range enforcement
- All 211 project tests passing

**Quality:**
- Code formatted with ruff
- All linting checks pass
- Type checking passes with ty
- Ready for integration with closest-target rule and combat system

## 2026-01-19

### Backend Setup (wsim-n6i) - COMPLETED
Initialized the Python backend project with a complete development environment:

**Infrastructure:**
- Created project structure with `wsim_core` (pure rules engine) and `wsim_api` (FastAPI wrapper)
- Set up package directories: models, engine, tables, events, serialization, routers, deps
- Configured `uv` for package management with Python 3.12+

**Dependencies:**
- FastAPI 0.115+ with uvicorn for ASGI server
- Pydantic v2 for data validation and models
- pytest with coverage, hypothesis, and httpx for testing
- ruff for formatting and linting (line-length 100)
- ty for strict type checking

**Quality Assurance:**
- All code formatted with ruff (12 files checked)
- All linting checks pass
- Type checking passes with ty (strict mode)
- Test suite runs successfully (2/2 tests passing)

**API Foundation:**
- Basic FastAPI application with health endpoint
- CORS configured for local development (ports 3000 and 5173)
- OpenAPI documentation available at /docs
- Test client setup with httpx

**Next Steps:**
Ready to implement core Pydantic models (wsim-vbx) for game state representation.

### Collision Detection and Resolution (wsim-n42) - COMPLETED
Implemented comprehensive collision detection and resolution system for simultaneous ship movement:

**Core Features:**
- Hex occupancy tracking: `detect_hex_occupancy()` builds map of which ships occupy which hexes
- Collision detection: `detect_collisions()` compares before/after positions to find collisions
- Smart resolution logic with proper priority rules:
  - Stationary ships have priority over moving ships
  - Random die roll (d6) when multiple ships move into same hex
  - Displaced ships moved back to previous positions
- Voluntary movement truncation for all ships involved in collisions
- Full event logging for audit trail and debugging

**Implementation:**
- Created `wsim_core/engine/collision.py` module (~290 lines)
- Integrates with existing RNG system for deterministic testing
- Uses Pydantic models for type safety (CollisionResolution, CollisionResult)
- Emits EventLogEntry objects for each collision with detailed metadata

**Testing:**
- Comprehensive test suite with 13 collision-specific tests
- Tests cover: hex occupancy, detection, resolution priorities, determinism
- All 152 tests pass (including existing tests)
- Test scenarios: bow collisions, stern collisions, multi-ship collisions
- Validates deterministic behavior with seeded RNG

**Quality Checks:**
- ruff formatting and linting: clean
- ty type checking (strict mode): clean
- Ready for integration into movement execution engine

**Next Steps:**
Ready to implement fouling system (wsim-8gn) which builds on collision detection.

### Drift Logic (wsim-znh) - COMPLETED
Implemented comprehensive drift system for ships that fail to advance their bow hex:

**Core Features:**
- Drift tracking: Ships track consecutive turns without bow advancement via `turns_without_bow_advance` counter
- Drift trigger: Ships drift 1 hex downwind after 2 turns without bow advance
- Downwind calculation: `get_downwind_direction()` determines drift direction (opposite of wind)
- Bounds validation: Prevents drift that would move ships off the map edge
- Position updates: Both bow and stern hexes move consistently in drift direction
- Counter management: Drift counter resets after drift application or successful bow advancement

**Implementation:**
- Created `wsim_core/engine/drift.py` module (~230 lines)
- Key functions:
  - `get_downwind_direction()`: Calculates drift direction from wind direction
  - `update_drift_tracking()`: Updates ship drift counters based on movement results
  - `apply_drift()`: Applies drift to eligible ships with bounds checking
  - `check_and_apply_drift()`: Convenience function combining tracking and drift
- Manual hex coordinate calculation to validate bounds before HexCoord creation
- Uses GamePhase enum for proper event type safety
- Emits EventLogEntry objects for both "drift" and "drift_blocked" events

**Testing:**
- Comprehensive test suite with 23 drift-specific tests
- Tests cover:
  - Downwind direction calculation for all 8 compass points
  - Drift tracking increments and resets
  - Drift application at 2-turn threshold
  - Bounds checking (all map edges: north, south, east, west)
  - Multiple ships drifting simultaneously
  - Event metadata validation and completeness
  - Integration scenarios with sequential turns
  - Preservation of other ship attributes during drift
- All 190 tests pass (23 new drift tests + 167 existing)

**Quality Checks:**
- ruff formatting and linting: clean
- ty type checking (strict mode): clean
- Ready for integration into movement execution engine

**Next Steps:**
Ready to implement broadside arc determination (wsim-9bf) for combat system.
